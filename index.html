<!doctype html>
<html lang="tr" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Talep Tahminleme + Kapasite Planlama</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    .file-drop {
      border: 2px dashed var(--bs-border-color);
      border-radius: .75rem;
      padding: 20px;
      text-align: center;
      transition: .15s;
    }
    .file-drop.dragover { background: var(--bs-secondary-bg); }
    .table-responsive { max-height: 60vh; }
    code { user-select: all; }
  </style>
</head>
<body>
  <div class="container-lg">
    <header class="mb-4">
      <div class="d-flex flex-wrap align-items-center gap-3">
        <h1 class="h3 mb-0">Eti Maden · Talep Tahminleme + Kapasite Planlama</h1>
        <div class="ms-auto d-flex align-items-center gap-2">
          <button id="themeToggle" class="btn btn-outline-secondary btn-sm" type="button">Tema</button>
          <a class="btn btn-outline-primary btn-sm" href="/download_last.csv" target="_blank" rel="noopener">CSV indir</a>
        </div>
      </div>
    </header>

    <div class="row g-4">
      <div class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h5">Girdi</h2>

            <form id="form" class="needs-validation" novalidate>
              <div class="mb-3">
                <label class="form-label">Geçmiş veri (.xlsx)</label>
                <div id="drop" class="file-drop">
                  <input id="file" class="form-control" type="file" name="file" accept=".xlsx" required>
                  <small class="text-body-secondary">En az <code>tarih</code> ve <code>talep</code> kolonları.</small>
                </div>
                <div class="invalid-feedback">XLSX gerekli.</div>
              </div>

              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">Tahmin ufku (h)</label>
                  <input class="form-control" type="number" name="h" min="1" value="12">
                </div>
                <div class="col-6">
                  <label class="form-label">Mevsimsellik (s)</label>
                  <input class="form-control" type="number" name="s" min="1" value="12">
                </div>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-6">
                  <label class="form-label">Tarih sütunu</label>
                  <input class="form-control" type="text" name="col_date" value="tarih">
                </div>
                <div class="col-6">
                  <label class="form-label">Talep sütunu</label>
                  <input class="form-control" type="text" name="col_demand" value="talep">
                </div>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-6">
                  <label class="form-label">Depo sütunu</label>
                  <input class="form-control" type="text" name="col_depo" value="depo">
                </div>
                <div class="col-6">
                  <label class="form-label">Ürün sütunu</label>
                  <input class="form-control" type="text" name="col_urun" value="urun">
                </div>
              </div>

              <div class="mt-2">
                <label class="form-label">Frekans (opsiyonel)</label>
                <input class="form-control" type="text" name="freq" placeholder="M, MS, W, D">
                <div class="form-text">Boşsa otomatik tahmin edilir.</div>
              </div>

              <div class="d-grid mt-3">
                <button id="runBtn" class="btn btn-primary" type="submit">
                  <span class="spinner-border spinner-border-sm me-2 d-none" id="spin" role="status" aria-hidden="true"></span>
                  Çalıştır
                </button>
              </div>
            </form>

            <hr>
            <p class="small text-body-secondary mb-0">
              Kapasite için <code>DATABASE_URL</code> tanımlıysa kökteki <code>database.sql</code> içindeki son <code>SELECT</code> sonucu kullanılır.
            </p>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center gap-2 mb-2">
              <h2 class="h5 mb-0">Sonuç</h2>
              <span id="capBadge" class="badge text-bg-secondary d-none"></span>
              <span id="countBadge" class="badge text-bg-info d-none"></span>
            </div>

            <div id="alert" class="alert alert-danger d-none" role="alert"></div>

            <div id="summary" class="mb-2 small text-body-secondary d-none"></div>

            <div class="table-responsive d-none" id="tableWrap">
              <table class="table table-sm table-hover align-middle">
                <thead id="thead"></thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>

            <nav id="pager" class="d-none">
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item"><button class="page-link" id="prev">Önceki</button></li>
                <li class="page-item disabled"><span class="page-link" id="pageInfo"></span></li>
                <li class="page-item"><button class="page-link" id="next">Sonraki</button></li>
              </ul>
            </nav>

          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tema
    document.getElementById('themeToggle').addEventListener('click', () => {
      const html = document.documentElement;
      html.setAttribute('data-bs-theme', html.getAttribute('data-bs-theme') === 'light' ? 'dark' : 'light');
    });

    // Drag&Drop
    const drop = document.getElementById('drop');
    drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
    drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
    drop.addEventListener('drop', e => {
      e.preventDefault(); drop.classList.remove('dragover');
      if (e.dataTransfer.files?.length) document.getElementById('file').files = e.dataTransfer.files;
    });

    // Form
    const form = document.getElementById('form');
    const runBtn = document.getElementById('runBtn');
    const spin = document.getElementById('spin');
    const alertBox = document.getElementById('alert');
    const tableWrap = document.getElementById('tableWrap');
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    const capBadge = document.getElementById('capBadge');
    const countBadge = document.getElementById('countBadge');
    const summaryBox = document.getElementById('summary');

    // Pagination
    let dataRows = [];
    let page = 1;
    const pageSize = 25;
    const pager = document.getElementById('pager');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const pageInfo = document.getElementById('pageInfo');

    function renderPage() {
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const slice = dataRows.slice(start, end);

      tbody.innerHTML = slice.map(r => {
        return `<tr>${columns.map(c => {
          const v = r[c];
          return `<td>${v === null || v === undefined ? '' : v}</td>`;
        }).join('')}</tr>`;
      }).join('');

      pageInfo.textContent = `Sayfa ${page} / ${Math.max(1, Math.ceil(dataRows.length / pageSize))}`;
      prevBtn.disabled = page === 1;
      nextBtn.disabled = end >= dataRows.length;
    }

    prevBtn.addEventListener('click', () => { if (page > 1) { page--; renderPage(); } });
    nextBtn.addEventListener('click', () => {
      const maxP = Math.ceil(dataRows.length / pageSize);
      if (page < maxP) { page++; renderPage(); }
    });

    let columns = [];

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      alertBox.classList.add('d-none');
      tableWrap.classList.add('d-none');
      pager.classList.add('d-none');
      summaryBox.classList.add('d-none');

      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      runBtn.disabled = true; spin.classList.remove('d-none');

      const fd = new FormData(form);
      try {
        const res = await fetch('/forecast', { method: 'POST', body: fd });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || ('HTTP ' + res.status));
        }
        const json = await res.json();

        // Badges
        capBadge.classList.remove('d-none');
        capBadge.textContent = `Kapasite: ${json.capacity_source}`;
        countBadge.classList.remove('d-none');
        countBadge.textContent = `Kayıt: ${json.n_kayit}`;

        // Summary
        summaryBox.classList.remove('d-none');
        summaryBox.innerHTML = `
          <span class="me-3">h=<strong>${json.h}</strong></span>
          <span class="me-3">s=<strong>${json.s}</strong></span>
          <span>Kolonlar: <code>${json.columns.join(', ')}</code></span>
        `;

        // Table
        columns = json.columns;
        thead.innerHTML = `<tr>${columns.map(c => `<th scope="col">${c}</th>`).join('')}</tr>`;
        dataRows = json.data || [];
        page = 1;
        renderPage();

        tableWrap.classList.remove('d-none');
        pager.classList.remove('d-none');

      } catch (err) {
        alertBox.textContent = (err?.message || String(err)).slice(0, 600);
        alertBox.classList.remove('d-none');
      } finally {
        runBtn.disabled = false; spin.classList.add('d-none');
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
